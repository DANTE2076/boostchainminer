name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake autoconf pkg-config \
            libcurl4-openssl-dev libjansson-dev \
            libssl-dev zlib1g-dev make g++

      - name: Build for Linux
        run: |
          ./autogen.sh
          ./configure --with-crypto --with-curl CFLAGS="-O2 -DUSE_ASM"
          make -j$(nproc)
          strip -s boostchainminer

      - name: Package Linux binary
        run: |
          mkdir -p dist
          tar -czf dist/boostchainminer-linux-x86_64.tar.gz boostchainminer README.md LICENSE

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: boostchainminer-linux
          path: dist/boostchainminer-linux-x86_64.tar.gz

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install automake autoconf pkg-config curl jansson openssl@3

      - name: Build for macOS
        run: |
          ./autogen.sh

          # Get Homebrew prefixes
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          CURL_PREFIX="$(brew --prefix curl)"
          JANSSON_PREFIX="$(brew --prefix jansson)"

          # Set up compiler flags
          export CPPFLAGS="-I$OPENSSL_PREFIX/include -I$CURL_PREFIX/include -I$JANSSON_PREFIX/include"
          export LDFLAGS="-L$OPENSSL_PREFIX/lib -L$CURL_PREFIX/lib -L$JANSSON_PREFIX/lib"

          # Run nomacro.pl if it exists
          if [ -f ./nomacro.pl ]; then
            ./nomacro.pl
          fi

          # Detect architecture and disable assembly on ARM64
          ARCH=$(uname -m)
          echo "Detected architecture: $ARCH"

          if [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
            echo "Building for ARM64 - disabling assembly optimizations"
            ./configure \
              --with-crypto="$OPENSSL_PREFIX" \
              --with-curl="$CURL_PREFIX" \
              --disable-assembly \
              CFLAGS="-O2"
          else
            echo "Building for x86_64 - enabling assembly optimizations"
            ./configure \
              --with-crypto="$OPENSSL_PREFIX" \
              --with-curl="$CURL_PREFIX" \
              CFLAGS="-O2 -DUSE_ASM"
          fi

          make -j$(sysctl -n hw.ncpu)
          strip boostchainminer

      - name: Package macOS binary
        run: |
          mkdir -p dist
          ARCH=$(uname -m)
          tar -czf dist/boostchainminer-macos-${ARCH}.tar.gz boostchainminer README.md LICENSE

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: boostchainminer-macos
          path: dist/boostchainminer-macos-*.tar.gz

  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-jansson
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib
            autoconf
            automake
            pkg-config
            make

      - name: Build for Windows
        run: |
          echo "=== Build Environment Info ==="
          uname -a
          gcc --version
          which gcc
          pkg-config --version
          echo "=============================="

          ./autogen.sh

          ./configure \
            --with-crypto \
            --with-curl \
            CFLAGS="-O2 -DUSE_ASM"

          make -j$(nproc)

          # The binary might be named cpuminer.exe or boostchainminer.exe
          if [ -f cpuminer.exe ]; then
            strip cpuminer.exe
            mv cpuminer.exe boostchainminer.exe
          elif [ -f boostchainminer.exe ]; then
            strip boostchainminer.exe
          fi

          echo "Build completed successfully"
          ls -lh boostchainminer.exe

      - name: Package Windows binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Compress-Archive -Path boostchainminer.exe,README.md,LICENSE -DestinationPath dist/boostchainminer-windows-x86_64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: boostchainminer-windows
          path: dist/boostchainminer-windows-x86_64.zip

  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/boostchainminer-linux/boostchainminer-linux-x86_64.tar.gz
            artifacts/boostchainminer-macos/boostchainminer-macos-*.tar.gz
            artifacts/boostchainminer-windows/boostchainminer-windows-x86_64.zip
          body: |
            # BoostChainMiner Release

            BoostChain CPU miner with x11r algorithm support.

            ## Downloads

            - **Linux (x86_64)**: boostchainminer-linux-x86_64.tar.gz
            - **macOS (Intel/Apple Silicon)**: boostchainminer-macos-*.tar.gz
            - **Windows (x86_64)**: boostchainminer-windows-x86_64.zip

            ## Quick Start

            ### Linux / macOS
            ```bash
            tar -xzf boostchainminer-*.tar.gz
            ./boostchainminer -a x11r \
              -o stratum+tcp://YOUR_POOL_HOST:PORT \
              -u YOUR_BOOST_ADDRESS.WORKER \
              -p x \
              -t $(nproc)
            ```

            ### Windows
            ```cmd
            boostchainminer.exe -a x11r -o stratum+tcp://YOUR_POOL_HOST:PORT -u YOUR_BOOST_ADDRESS.WORKER -p x -t 4
            ```

            ## Notes

            - **macOS ARM64 (Apple Silicon)**: Assembly optimizations are disabled for compatibility. Performance is slightly lower but fully functional.
            - **macOS x86_64 (Intel)**: Full assembly optimizations enabled.
            - For more information, see the README.md file.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
